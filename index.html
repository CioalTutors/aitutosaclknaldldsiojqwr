<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tutor AI Agent</title>
    
    <link id="manifest-link" rel="manifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .blur-overlay { backdrop-filter: blur(12px); background: rgba(255,255,255,0.8); }
    </style>
</head>
<body class="text-slate-900 pb-20 sm:pb-0">

    <!-- Password Protection Gate -->
    <div id="authGate" class="fixed inset-0 z-[200] bg-indigo-600 flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full text-center">
            <div class="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 text-indigo-600">
                <i class="fas fa-lock text-2xl"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 uppercase tracking-tight mb-2">Secure Access</h2>
            <p class="text-slate-400 text-sm font-bold uppercase tracking-widest mb-6">Private Database</p>
            <input type="password" id="accessCode" placeholder="Enter Access Code" class="w-full p-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:border-indigo-500 outline-none text-center font-bold tracking-[0.3em] mb-4">
            <button onclick="checkAuth()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-600 transition-all active:scale-95">Unlock App</button>
            <p id="authError" class="text-red-500 text-xs font-bold mt-4 hidden">Invalid Access Code</p>
        </div>
    </div>

    <!-- Main Content (Hidden until Unlocked) -->
    <div id="appContent" class="hidden">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center text-center px-6">
            <div class="relative mb-8 scale-125">
                <div class="w-16 h-16 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin"></div>
                <i class="fas fa-bolt text-indigo-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl"></i>
            </div>
            <h3 class="text-lg font-extrabold tracking-widest uppercase text-slate-800">Tutor AI Search</h3>
            <p id="loadingStatus" class="text-xs font-bold text-slate-400 mt-2 uppercase tracking-[0.3em]">Connecting Database</p>
        </div>

        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-[1600px] mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-xl shadow-lg">
                        <i class="fas fa-graduation-cap text-white text-lg"></i>
                    </div>
                    <h1 class="text-lg font-black tracking-tighter text-slate-800 uppercase">Tutor Hub AI</h1>
                </div>
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                    <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                    <span id="recordCount" class="text-[9px] font-black text-slate-600 uppercase">Syncing...</span>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto px-4 sm:px-6 py-6">
            <section class="mb-8">
                <div class="bg-white rounded-3xl p-6 sm:p-8 border border-slate-200 shadow-xl shadow-slate-200/20">
                    <form id="searchForm" class="relative">
                        <textarea id="searchInput" placeholder="e.g. Physics tutor in Karachi, 5 years experience..." class="w-full p-5 pr-32 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:border-indigo-500 transition-all outline-none min-h-[100px] resize-none text-base sm:text-lg font-medium"></textarea>
                        <button type="submit" id="searchButton" class="absolute bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 transition-all font-black text-xs uppercase tracking-widest disabled:bg-slate-300">
                            <i class="fas fa-search mr-1"></i> Search <i id="btnLoader" class="fas fa-circle-notch loading-spin hidden ml-1"></i>
                        </button>
                    </form>
                </div>
            </section>

            <div id="messageArea" class="hidden animate-fade-in mb-8"></div>

            <div id="resultsWrapper" class="hidden space-y-4 animate-fade-in">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Matching Applicants</h3>
                    <button onclick="resetSearch()" class="text-[10px] font-black text-slate-300 hover:text-red-500 uppercase tracking-widest">Reset</button>
                </div>
                <div class="bg-white rounded-[1.5rem] border border-slate-200 shadow-2xl overflow-hidden">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse min-w-[1400px]">
                            <thead>
                                <tr class="bg-slate-50/50 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    <th class="px-6 py-5 text-center w-14">#</th>
                                    <th class="px-6 py-5 w-32">Timestamp</th>
                                    <th class="px-6 py-5 w-[200px]">Name</th>
                                    <th class="px-6 py-5 w-[160px]">WhatsApp number</th>
                                    <th class="px-6 py-5 w-[130px]">Years of Experience</th>
                                    <th class="px-6 py-5">Highest Qualification & Institute</th>
                                    <th class="px-6 py-5">Subjects you can teach?</th>
                                    <th class="px-6 py-5 w-[250px]">Areas you can teach in?</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="text-center py-32 bg-white rounded-[2rem] border-2 border-dashed border-slate-100">
                <i class="fas fa-database text-slate-100 text-5xl mb-4"></i>
                <p class="text-xs font-black text-slate-300 uppercase tracking-[0.2em]">Database Connected</p>
            </div>
        </main>
    </div>

    <script>
        const apiKey = "";
        const GSHEET_URL = 'https://docs.google.com/spreadsheets/d/1tb4lnBTw6f8Pa6Iko_xQvMFydHtjWsjHCIaxLkNRDVc/export?format=csv';
        // YOU CAN CHANGE YOUR PASSWORD HERE
        const APP_PASSWORD = "123"; 

        function checkAuth() {
            const input = document.getElementById('accessCode').value;
            const error = document.getElementById('authError');
            if(input === APP_PASSWORD) {
                document.getElementById('authGate').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                init();
            } else {
                error.classList.remove('hidden');
            }
        }

        // PWA Manifest
        const manifest = {
            "name": "Tutor AI Private",
            "short_name": "TutorAI",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#4f46e5",
            "theme_color": "#4f46e5",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", "sizes": "512x512", "type": "image/png" }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(manifestBlob));

        let db = [];
        function parseCSV(text) {
            const rows = [];
            let field = '', inQuotes = false, current = [];
            for (let i = 0; i < text.length; i++) {
                const c = text[i], n = text[i+1];
                if (c === '"') {
                    if (inQuotes && n === '"') { field += '"'; i++; } else inQuotes = !inQuotes;
                } else if (c === ',' && !inQuotes) { current.push(field.trim()); field = ''; }
                else if ((c === '\n' || c === '\r') && !inQuotes) {
                    current.push(field.trim());
                    if (current.some(f => f.length > 0)) rows.push(current);
                    current = []; field = '';
                    if (c === '\r' && n === '\n') i++;
                } else field += c;
            }
            if (current.length > 0) { current.push(field.trim()); rows.push(current); }
            return rows;
        }

        async function init() {
            try {
                const res = await fetch(`${GSHEET_URL}&cb=${Date.now()}`);
                if (!res.ok) throw new Error();
                const text = await res.text();
                const rows = parseCSV(text);
                const headers = rows[0].map(h => h.replace(/"/g, '').trim());
                db = rows.slice(1).map(row => {
                    const item = {};
                    headers.forEach((h, i) => item[h] = (row[i] || '').replace(/"/g, ''));
                    return item;
                }).filter(r => r.Name && r.Name.length > 1);

                document.getElementById('recordCount').innerText = `${db.length} Records`;
                document.getElementById('statusDot').className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
                document.getElementById('loadingOverlay').classList.add('hidden');
            } catch (err) {
                document.getElementById('loadingStatus').innerText = "Sync Error - Check Connection";
            }
        }

        async function search(query) {
            const context = db.slice(0, 350).map(t => ({
                t: t.Timestamp, n: t.Name, w: t['WhatsApp number'], e: t['Years of Experience'],
                q: t['Highest Qualification & Institute'], s: t['Subjects you can teach?'], a: t['Areas you can teach in?']
            }));
            const payload = {
                contents: [{ parts: [{ text: `Search: ${query}\nData: ${JSON.stringify(context)}` }] }],
                systemInstruction: { parts: [{ text: "Return ONLY JSON object with 'matches' array. Keys: timestamp, name, whatsapp, experience, qualification, subjects, areas. Max 10 results. No summary." }] },
                generationConfig: { responseMimeType: "application/json" }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text).matches;
        }

        document.getElementById('searchForm').onsubmit = async (e) => {
            e.preventDefault();
            const q = document.getElementById('searchInput').value.trim();
            if (!q || db.length === 0) return;
            const btn = document.getElementById('searchButton'), loader = document.getElementById('btnLoader'), area = document.getElementById('messageArea');
            btn.disabled = true; loader.classList.remove('hidden'); area.classList.add('hidden');
            try {
                const results = await search(q);
                const body = document.getElementById('resultsTableBody');
                body.innerHTML = '';
                if (!results || results.length === 0) {
                    area.innerHTML = '<div class="bg-amber-50 border border-amber-200 p-4 rounded-xl text-amber-800 font-bold text-center">No matches found.</div>';
                    area.classList.remove('hidden');
                } else {
                    results.forEach((t, i) => {
                        const cleanPhone = t.whatsapp.replace(/\D/g,'');
                        body.innerHTML += `
                            <tr class="hover:bg-indigo-50/20 transition-all group text-xs">
                                <td class="px-6 py-6 text-center font-black text-slate-300">${i + 1}</td>
                                <td class="px-6 py-6 text-slate-400 whitespace-nowrap uppercase">${t.timestamp}</td>
                                <td class="px-6 py-6 font-black text-slate-800 text-sm uppercase">${t.name}</td>
                                <td class="px-6 py-6">
                                    <a href="https://wa.me/${cleanPhone}" target="_blank" class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-xl font-black hover:bg-emerald-600 hover:text-white transition-all shadow-sm">
                                        <i class="fab fa-whatsapp"></i> ${t.whatsapp}
                                    </a>
                                </td>
                                <td class="px-6 py-6 font-bold text-slate-600 italic uppercase">${t.experience}</td>
                                <td class="px-6 py-6 font-bold text-slate-500 leading-tight italic max-w-[250px]">${t.qualification}</td>
                                <td class="px-6 py-6 font-bold text-slate-700 max-w-[300px] leading-relaxed">${t.subjects}</td>
                                <td class="px-6 py-6 font-bold text-slate-500 max-w-[200px] leading-tight italic">${t.areas}</td>
                            </tr>`;
                    });
                    document.getElementById('resultsWrapper').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                }
            } catch (err) {
                area.innerHTML = '<div class="bg-red-50 border border-red-200 p-4 rounded-xl text-red-800 font-bold text-center italic uppercase tracking-tighter">AI SEARCH ERROR. Check Key.</div>';
                area.classList.remove('hidden');
            } finally { btn.disabled = false; loader.classList.add('hidden'); }
        };

        function resetSearch() {
            document.getElementById('resultsWrapper').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('searchInput').value = '';
            document.getElementById('messageArea').classList.add('hidden');
        }
    </script>
</body>
</html>
