<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#84cc16">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tutor AI Agent</title>
    
    <link id="manifest-link" rel="manifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f7fee7; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2365a30d' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #bef264; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900 pb-24 sm:pb-0">

    <!-- API Key Entry Gate -->
    <div id="authGate" class="fixed inset-0 z-[200] bg-lime-600 flex items-center justify-center p-6 overflow-y-auto">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-sm w-full text-center my-auto">
            <div class="bg-lime-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 text-lime-600">
                <i class="fas fa-bolt text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight mb-2 uppercase italic">Tutor Engine</h2>
            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-8">Personal AI Search Agent</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block text-left ml-4 mb-1 tracking-tighter">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="Enter API Key" class="w-full p-4 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:border-lime-500 outline-none text-center font-mono text-xs shadow-inner">
                </div>
                <button onclick="checkAuth()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-lime-600 transition-all shadow-xl shadow-lime-100 active:scale-95">Sync & Launch</button>
                <p id="authError" class="text-red-500 text-[10px] font-black mt-2 hidden">INVALID KEY DETECTED</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="appContent" class="hidden">
        <!-- Persistent Loader for First Fetch -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center text-center px-6">
            <div class="relative mb-8 scale-125">
                <div class="w-16 h-16 border-4 border-slate-100 border-t-lime-600 rounded-full animate-spin"></div>
                <i class="fas fa-server text-lime-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl"></i>
            </div>
            <h3 class="text-lg font-black tracking-widest uppercase text-slate-800">Tutor Hub AI</h3>
            <p id="loadingStatus" class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-[0.3em]">Mapping Database</p>
        </div>

        <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm px-4 sm:px-6 py-4">
            <div class="max-w-[1600px] mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-lime-600 p-2 rounded-xl shadow-lg shadow-lime-200">
                        <i class="fas fa-graduation-cap text-white text-lg"></i>
                    </div>
                    <h1 class="text-lg font-black tracking-tighter text-slate-800 uppercase leading-none">Tutor Hub AI</h1>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="logout()" class="p-2 text-slate-300 hover:text-red-500 transition-colors" title="Settings"><i class="fas fa-sync-alt"></i></button>
                    <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                        <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                        <span id="recordCount" class="text-[9px] font-black text-slate-600 uppercase">Indexing...</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto px-4 sm:px-6 py-6">
            <!-- Mode Selector -->
            <div class="flex gap-2 mb-6 p-1.5 bg-white rounded-2xl border border-slate-200 shadow-sm max-w-fit mx-auto sm:mx-0">
                <button id="aiTab" onclick="switchTab('ai')" class="px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-lime-600 text-white shadow-lg shadow-lime-100">AI Search Engine</button>
                <button id="manualTab" onclick="switchTab('manual')" class="px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:bg-slate-50">Quick Filters</button>
            </div>

            <!-- AI Panel -->
            <section id="aiPanel" class="mb-8 block animate-fade-in">
                <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-xl shadow-slate-200/20 overflow-hidden relative">
                    <div class="absolute -top-10 -right-10 opacity-5 pointer-events-none">
                        <i class="fas fa-brain text-[120px] text-lime-600"></i>
                    </div>
                    <form id="searchForm" class="relative z-10">
                        <textarea id="searchInput" placeholder="Search (e.g. 'Experienced Math tutor in Lahore, background in A-Levels')..." class="w-full p-6 pr-32 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:border-lime-500 transition-all outline-none min-h-[120px] resize-none text-base font-medium shadow-inner"></textarea>
                        <button type="submit" id="searchButton" class="absolute bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg bg-lime-600 text-white hover:bg-lime-700 active:scale-95 transition-all flex items-center gap-2 font-black text-xs uppercase tracking-widest">
                            <i class="fas fa-bolt"></i> <span class="hidden sm:inline">Run AI</span> <i id="btnLoader" class="fas fa-circle-notch loading-spin hidden ml-1"></i>
                        </button>
                    </form>
                </div>
            </section>

            <!-- Manual Panel -->
            <section id="manualPanel" class="mb-8 hidden animate-fade-in">
                <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-xl shadow-slate-200/20 grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">City</label>
                        <select id="selCity" onchange="manualFilter()" class="w-full p-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-lime-500 outline-none text-xs font-bold text-slate-600"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Category</label>
                        <select id="selEdu" onchange="manualFilter()" class="w-full p-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-lime-500 outline-none text-xs font-bold text-slate-600"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Core Subject</label>
                        <select id="selSub" onchange="manualFilter()" class="w-full p-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-lime-500 outline-none text-xs font-bold text-slate-600"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Class Group</label>
                        <select id="selClass" onchange="manualFilter()" class="w-full p-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-lime-500 outline-none text-xs font-bold text-slate-600"></select>
                    </div>
                </div>
            </section>

            <div id="messageArea" class="hidden animate-fade-in mb-8"></div>

            <!-- Table UI -->
            <div id="resultsWrapper" class="hidden space-y-4 animate-fade-in">
                <div class="flex items-center justify-between px-2">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Database Matches</h3>
                    <button onclick="reset()" class="text-[10px] font-black text-slate-300 hover:text-lime-600 uppercase tracking-widest">Clear Results</button>
                </div>
                <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl overflow-hidden">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse min-w-[1400px]">
                            <thead>
                                <tr class="bg-slate-50/50 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                    <th class="px-6 py-5 text-center w-14">#</th>
                                    <th class="px-6 py-5 w-32">Timestamp</th>
                                    <th class="px-6 py-5 w-[200px]">Name</th>
                                    <th class="px-6 py-5 w-[160px]">WhatsApp number</th>
                                    <th class="px-6 py-5 w-[120px]">Years of Experience</th>
                                    <th class="px-6 py-5">Highest Qualification & Institute</th>
                                    <th class="px-6 py-5">Subjects you can teach?</th>
                                    <th class="px-6 py-5 w-[250px]">Areas you can teach in?</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="emptyState" class="text-center py-40 border-2 border-dashed border-slate-200 rounded-[3rem]">
                <i class="fas fa-layer-group text-slate-100 text-6xl mb-4"></i>
                <p class="text-xs font-black text-slate-300 uppercase tracking-[0.2em]">Select criteria to begin search</p>
            </div>
        </main>
    </div>

    <script>
        let apiKey = localStorage.getItem('tutor_ai_apikey') || "";
        const GSHEET_URL = 'https://docs.google.com/spreadsheets/d/1tb4lnBTw6f8Pa6Iko_xQvMFydHtjWsjHCIaxLkNRDVc/export?format=csv';
        let db = [];

        const CATEGORIES = {
            Cities: ["Lahore", "Karachi", "Islamabad", "Rawalpindi", "Faisalabad", "Multan", "Peshawar", "Sialkot", "Gujranwala"],
            Levels: ["O-Level", "A-Level", "Matric", "FSc", "Bachelors", "Masters", "Primary", "Middle"],
            Subjects: ["Mathematics", "Physics", "Chemistry", "Biology", "Computer Science", "English", "Urdu", "Economics", "Accounting"]
        };

        function switchTab(mode) {
            const isAI = mode === 'ai';
            document.getElementById('aiPanel').classList.toggle('hidden', !isAI);
            document.getElementById('manualPanel').classList.toggle('hidden', isAI);
            document.getElementById('aiTab').className = isAI ? "px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-lime-600 text-white shadow-lg shadow-lime-100" : "px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:bg-slate-50";
            document.getElementById('manualTab').className = !isAI ? "px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-lime-600 text-white shadow-lg shadow-lime-100" : "px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:bg-slate-50";
        }

        function checkAuth() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if(input.length > 10) {
                apiKey = input;
                localStorage.setItem('tutor_ai_apikey', apiKey);
                document.getElementById('authGate').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                init();
            } else { document.getElementById('authError').classList.remove('hidden'); }
        }

        function logout() {
            if(confirm("Change setup settings?")) {
                localStorage.removeItem('tutor_ai_apikey');
                location.reload();
            }
        }

        function parseCSV(text) {
            const rows = [];
            let field = '', inQuotes = false, current = [];
            for (let i = 0; i < text.length; i++) {
                const c = text[i], n = text[i+1];
                if (c === '"') {
                    if (inQuotes && n === '"') { field += '"'; i++; } else inQuotes = !inQuotes;
                } else if (c === ',' && !inQuotes) { current.push(field.trim()); field = ''; }
                else if ((c === '\n' || c === '\r') && !inQuotes) {
                    current.push(field.trim());
                    if (current.some(f => f.length > 0)) rows.push(current);
                    current = []; field = '';
                    if (c === '\r' && n === '\n') i++;
                } else field += c;
            }
            if (current.length > 0) { current.push(field.trim()); rows.push(current); }
            return rows;
        }

        async function init() {
            try {
                const res = await fetch(`${GSHEET_URL}&cb=${Date.now()}`);
                const text = await res.text();
                const rows = parseCSV(text);
                const headers = rows[0].map(h => h.replace(/"/g, '').trim());
                db = rows.slice(1).map(row => {
                    const item = {};
                    headers.forEach((h, i) => item[h] = (row[i] || '').replace(/"/g, ''));
                    return item;
                }).filter(r => r.Name);

                setupFilters();
                document.getElementById('recordCount').innerText = `${db.length} Records`;
                document.getElementById('statusDot').className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
                document.getElementById('loadingOverlay').classList.add('hidden');
            } catch (err) {
                document.getElementById('loadingStatus').innerText = "CORS Connection Error - Host on HTTPS";
            }
        }

        function setupFilters() {
            const fill = (id, label, list) => {
                const s = document.getElementById(id);
                s.innerHTML = `<option value="">All ${label}</option>` + 
                              list.map(v => `<option value="${v}">${v}</option>`).join('');
            };
            fill('selCity', 'Cities', CATEGORIES.Cities);
            fill('selEdu', 'Edu Category', CATEGORIES.Levels);
            fill('selSub', 'Subjects', CATEGORIES.Subjects);
            fill('selClass', 'Class Group', ["Primary (1-5)", "Middle (6-8)", "O-Level / Matric", "A-Level / FSc", "University"]);
        }

        function manualFilter() {
            const city = document.getElementById('selCity').value.toLowerCase();
            const edu = document.getElementById('selEdu').value.toLowerCase();
            const sub = document.getElementById('selSub').value.toLowerCase();
            const cls = document.getElementById('selClass').value.toLowerCase();

            const matches = db.filter(r => {
                const rCity = (r.City || '').toLowerCase();
                const rSub = (r['Subjects you can teach?'] || '').toLowerCase();
                const rClass = (r['Classes You Can Teach?'] || '').toLowerCase();
                const rEdu = (r['Educational Background'] || '').toLowerCase() + (r['Highest Qualification & Institute'] || '').toLowerCase();

                return (!city || rCity.includes(city)) &&
                       (!edu || rEdu.includes(edu.replace('-level',''))) &&
                       (!sub || rSub.includes(sub)) &&
                       (!cls || rClass.includes(cls.split(' ')[0].toLowerCase()));
            }).slice(0, 50);

            render(matches);
        }

        function render(matches) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            if(!matches || matches.length === 0) {
                document.getElementById('resultsWrapper').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            matches.forEach((t, i) => {
                const phone = (t['WhatsApp number'] || '').replace(/\D/g,'');
                body.innerHTML += `
                    <tr class="hover:bg-lime-50 transition-all text-[11px] group font-medium animate-fade-in">
                        <td class="px-6 py-6 text-center font-black text-slate-300">${i+1}</td>
                        <td class="px-6 py-6 text-slate-400 whitespace-nowrap">${t.Timestamp}</td>
                        <td class="px-6 py-6 font-black text-slate-800 text-sm uppercase">${t.Name}</td>
                        <td class="px-6 py-6">
                            <a href="https://wa.me/${phone}" target="_blank" class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-xl font-black hover:bg-emerald-600 hover:text-white transition-all shadow-sm">
                                <i class="fab fa-whatsapp"></i> ${t['WhatsApp number']}
                            </a>
                        </td>
                        <td class="px-6 py-6 font-bold text-slate-500 italic uppercase">${t['Years of Experience']}</td>
                        <td class="px-6 py-6 italic leading-tight max-w-[250px]">${t['Highest Qualification & Institute']}</td>
                        <td class="px-6 py-6 font-bold text-slate-700 max-w-[300px] leading-relaxed">${t['Subjects you can teach?']}</td>
                        <td class="px-6 py-6 italic max-w-[200px] leading-tight">${t['Areas you can teach in?']}</td>
                    </tr>`;
            });
            document.getElementById('resultsWrapper').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        async function searchAI(query) {
            // Context Optimization: Lighten the payload for speed
            const context = db.slice(0, 350).map(t => ({
                t: t.Timestamp, n: t.Name, w: t['WhatsApp number'], e: t['Years of Experience'],
                q: t['Highest Qualification & Institute'], s: t['Subjects you can teach?'], a: t['Areas you can teach in?']
            }));

            // FASTER PROMPT: Instructions to categorize user intent first to minimize model confusion
            const systemPrompt = `
                ACT AS A SPECIALIZED FILTER ENGINE. 
                1. ANALYZE intent: Identify requested Level (O/A/Matric), Subject, and Location.
                2. SCAN Database provided below.
                3. EXTRACT top 10 most recent matches exactly.
                4. RETURN strictly JSON object with a "matches" array using keys: timestamp, name, whatsapp, experience, qualification, subjects, areas.
                DO NOT SUMMARIZE OR ADD TEXT.
            `;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Search Criteria: ${query}\n\nDataset: ${JSON.stringify(context)}` }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await res.json();
            const list = JSON.parse(data.candidates[0].content.parts[0].text).matches;
            return list.map(r => ({
                Timestamp: r.timestamp, Name: r.name, "WhatsApp number": r.whatsapp, "Years of Experience": r.experience,
                "Highest Qualification & Institute": r.qualification, "Subjects you can teach?": r.subjects, "Areas you can teach in?": r.areas
            }));
        }

        document.getElementById('searchForm').onsubmit = async (e) => {
            e.preventDefault();
            const q = document.getElementById('searchInput').value.trim();
            if(!q) return;
            const btn = document.getElementById('searchButton'), loader = document.getElementById('btnLoader');
            btn.disabled = true; loader.classList.remove('hidden');
            try { render(await searchAI(q)); }
            catch (err) { alert("Search engine timeout. Please use Manual Filters for faster results."); }
            finally { btn.disabled = false; loader.classList.add('hidden'); }
        };

        function reset() {
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.getElementById('resultsWrapper').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        if(apiKey.length > 10) {
            document.getElementById('authGate').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            init();
        }

        // PWA Meta Injection
        const manifest = {
            "name": "Tutor Engine AI", "short_name": "TutorAI", "start_url": ".", "display": "standalone",
            "background_color": "#f7fee7", "theme_color": "#84cc16",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", "sizes": "512x512", "type": "image/png" }]
        };
        document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));
    </script>
</body>
</html>

